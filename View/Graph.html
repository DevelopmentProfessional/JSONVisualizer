<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graph Viewer - APIRunner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body class="overflow-auto min-vh-100"> 
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark position-fixed top-0 start-0 end-0" style="z-index: 999;">
    <div class="container-fluid">
        <a class="navbar-brand" href="#"><i class="bi bi-graph-up"></i> Graph Viewer</a>
        <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link" href="ManageAPI.html">Manage API</a></li>
            <li class="nav-item"><a class="nav-link" href="GraphControls.html">Graph Controls</a></li>
            <li class="nav-item"><a class="nav-link active" href="Graph.html">Visualizer</a></li>
            <li class="nav-item"><a class="nav-link" href="Variables.html">Variables</a></li>
            <li class="nav-item"><a class="nav-link" href="Run.html">Run</a></li>
        </ul>
    </div>
  </nav>

  <div id="graphContainer" class="position-fixed top-0 start-0 w-100 h-100" style="z-index:1; padding-top:70px;"></div>

  <!-- Compact Top Control Bar -->
  <div id="controlBar" class="position-fixed top-0 start-50 translate-middle-x bg-dark bg-opacity-75 border-bottom border-secondary w-100" style="padding-top:60px; z-index: 998;">
    <div class="container-fluid py-2">
      <div class="d-flex flex-row flex-wrap justify-content-center gap-3 align-items-end">
        <!-- Group 1: Data Source + Mappings Table -->
        <div class="input-group input-group-sm align-items-end" style="min-width:260px;max-width:340px;">
          <span class="input-group-text">Data Source</span>
          <select id="dsSelect" class="form-select"></select>
          <button id="toggleMappingTable" type="button" class="btn btn-outline-secondary" title="Show/Hide Mappings Table"><i id="mappingTableIcon" class="bi bi-table"></i></button>
        </div>
        <!-- Group 2: Mapping + Data Table -->
        <div class="input-group input-group-sm align-items-end" style="min-width:260px;max-width:340px;">
          <span class="input-group-text">Mapping</span>
          <select id="mappingSelect" class="form-select" disabled></select>
          <button id="toggleDataTable" type="button" class="btn btn-outline-secondary" title="Show/Hide Data Table"><i id="dataTableIcon" class="bi bi-table"></i></button>
        </div>
        <!-- Group 3: Charts + Search -->
        <div class="input-group input-group-sm align-items-end" style="min-width:320px;max-width:420px;">
          <span class="input-group-text">Charts</span>
          <button id="openChartPicker" type="button" class="btn btn-outline-secondary">Select…</button>
          <input id="chartSearch" type="text" class="form-control" placeholder="Filter charts" oninput="filterCharts()" />
        </div>
        <span class="badge bg-secondary align-self-center" id="mappingStatus"></span>
      </div>
    </div>
  </div>

  <div id="statusArea" class="position-fixed" style="bottom:10px; left:10px; z-index:2000; max-width:400px;"></div>

  <!-- Floating Chart Picker Panel -->
  <div id="chartPickerPanel" class="card shadow border-secondary d-none" style="position:fixed; top:120px; left:50%; transform:translateX(-50%); width: min(1000px,90%); max-height:60vh; overflow:auto; z-index:1999; background:#1a1d21;">
    <div class="card-header py-2 d-flex justify-content-between align-items-center">
      <strong class="small">Chart Library</strong>
      <div class="d-flex align-items-center gap-2">
        <small class="text-secondary" id="chartCount"></small>
        <button type="button" id="closeChartPicker" class="btn btn-sm btn-outline-light"><i class="bi bi-x"></i></button>
      </div>
    </div>
    <div class="card-body py-2">
      <div class="accordion" id="chartCategoriesAccordion"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tabulator-tables@6.2.1/dist/css/tabulator_midnight.min.css">
  <script src="https://cdn.jsdelivr.net/npm/tabulator-tables@6.2.1/dist/js/tabulator.min.js"></script>
  <!-- Local offline D3 & geo-projection vendored in /vendor (see scripts/copy-d3.js) -->
  <script src="../vendor/d3/d3.min.js"></script>
  <script src="../vendor/d3-geo-projection/d3-geo-projection.min.js"></script>
  <script type="module" src="graphLoader.js"></script>
  <script>
    // Adjust graph container top padding (nav ~56px + control bar height)
    function adjustGraphContainerPadding(){
      const gc = document.getElementById('graphContainer');
      gc.style.paddingTop = '120px';
    }
    document.addEventListener('DOMContentLoaded', adjustGraphContainerPadding);
    // Category and chart definitions
    const chartCategories = {
      'Animation': [ 'Animated treemap','Temporal force-directed graph','Connected scatterplot','The wealth & health of nations','Scatterplot tour','Bar chart race','Stacked-to-grouped bars','Streamgraph transitions','Smooth zooming','Zoom to bounding box','Orthographic to equirectangular','World tour','Walmart’s growth','Hierarchical bar chart','Zoomable treemap','Zoomable circle packing','Collapsible tree','Zoomable icicle','Zoomable sunburst','Sortable bar chart','Icelandic population by age 1841–2019','Pie chart update','Arc tween' ],
      'Interaction': [ 'Versor dragging','Index chart','Sequences sunburst','Brushable scatterplot','Brushable scatterplot matrix','Pannable chart','Zoomable area chart','Zoomable bar chart','Seamless zoomable map tiles' ],
      'Analysis': [ 'Moving average','Bollinger bands','Box plot','Histogram','Kernel density estimation','Density contours','Volcano contours','Contours','Hexbin','Hexbin (area)','Hexbin map','Q–Q plot','Normal quantile plot','Parallel sets' ],
      'Hierarchies': [ 'Treemap','Cascaded treemap','Nested treemap','Circle packing','Indented tree','Tidy tree','Radial tidy tree','Cluster dendrogram','Radial dendrogram','Sunburst','Icicle','Tangled tree visualization','Phylogenetic tree','Force-directed tree' ],
      'Networks': [ 'Force-directed graph','Disjoint force-directed graph','Mobile patent suits','Arc diagram','Sankey diagram','Hierarchical edge bundling','Chord diagram','Directed chord diagram','Chord dependency diagram' ],
      'Bars': [ 'Bar chart','Horizontal bar chart','Diverging bar chart','Stacked bar chart','Stacked horizontal bar chart','Stacked normalized horizontal bar chart','Grouped bar chart','Diverging stacked bar chart','Marimekko chart','World history timeline','The impact of vaccines','Electricity usage 2019','Revenue by music format 1973–2018' ],
      'Calendars': [ 'Calendar' ],
      'Lines': [ 'Line chart','Line with missing data','Multi-line chart','Change line chart','Slope chart','Slope chart II','Marey’s trains','Candlestick chart','Variable-color line','Gradient encoding','Threshold encoding','Parallel coordinates','Inequality in American cities','New Zealand tourists 1921–2018','Sea ice extent 1978–2017' ],
      'Areas': [ 'Area chart','Area with missing data','Stacked area chart','Normalized stacked area chart','U.S. population by state 1790–1990','Streamgraph','Difference chart','Band chart','Ridgeline (joy) plot','Horizon chart','Realtime horizon chart' ],
      'Dots': [ 'Scatterplot','Scatterplot with shapes','Scatterplot matrix','Dot plot','Global temperature trends','Bubble map','Spike map','Bubble chart','Beeswarm','Mirrored beeswarm','Hertzsprung–Russell diagram' ],
      'Radial': [ 'Pie chart','Donut chart','Radial area chart','Radial stacked bar chart','Radial stacked bar chart (sorted)' ],
      'Annotation': [ 'Inline labels','Directly labeling lines','Line chart with tooltip','Voronoi labels','Occlusion','Graticule labels','Styled axes','Color legend' ],
      'Maps': [ 'Choropleth','Bivariate choropleth','State choropleth','World choropleth','World map','Projection transitions','Projection comparison','Antimeridian cutting','Tissot’s indicatrix','Web Mercator tiles','Raster tiles','Vector tiles','Clipped map tiles','Raster & vector','Vector field','GeoTIFF contours','U.S. airports voronoi','World airports voronoi','Solar terminator','Solar path','Star map','Non-contiguous cartogram' ],
      'Essays': [ 'd3.packEnclose','Centerline labeling','Methods of comparison compared','Predator and prey' ],
      'Just for Fun': [ 'Polar clock','Stern–Brocot tree','Voronoi stippling','Watercolor','PSR B1919+21','Epicyclic gearing','Owls to the max','Tadpoles','Word cloud','Spilhaus shoreline map','Phases of the moon','Color schemes' ],
      'd3-contour': [ 'Contour polygons','Density estimation' ],
      'd3-delaunay': [ 'Delaunay triangulations','Voronoi diagrams' ],
      'd3-force': [ 'Force simulations','Center force','Collide force','Link force','Many-body force','Position forces' ],
      'd3-geo': [ 'Paths','Projections','Streams','Spherical shapes','Spherical math' ],
      'd3-hierarchy': [ 'Hierarchies','Stratify','Tree','Cluster','Partition','Pack','Treemap' ]
    };

  // Utility slugify & alias maps hoisted for reuse
  const slugify = str => str.toLowerCase()
      .replace(/[’']/g,'')
      .replace(/&/g,' and ')
      .replace(/[^a-z0-9]+/g,'-')
      .replace(/-+/g,'-')
      .replace(/^-|-$/g,'');
  const alias = {
    'force-directed-graph':'force-directed',
    'collapsible-tree':'tree',
    'tidy-tree':'tree',
    'radial-tidy-tree':'tree',
    'cluster-dendrogram':'tree',
    'radial-dendrogram':'tree',
    'indented-tree':'tree',
    'force-directed-tree':'tree',
  'bar-chart':'bar-chart',
  // Treemap variants map to hierarchy-treemap implementation
  'treemap':'hierarchy-treemap',
  'zoomable-treemap':'hierarchy-treemap',
  'cascaded-treemap':'hierarchy-treemap',
  'nested-treemap':'hierarchy-treemap'
  };

  let allowedGraphTypes = null; // Set of graph type slugs allowed by current mapping
  let selectedGraphType = null; // currently selected (normalized) graph type
  let activeGenericMapping = null; // unified mapping (rowPath + field roles) reused across any chart
  let activeMappingName = null;

  // Extract array of rows based on a dot/bracket path (simple implementation)
  function extractRows(raw, rowPath) {
    if (!rowPath) return raw;
    try {
      const clean = rowPath.replace(/^\$\./,'');
      const parts = clean.split('.').filter(Boolean);
      let ref = raw;
      for (const p of parts) {
        if (ref == null) return [];
        // Handle namespace-like keys with colon e.g. 'wb:countries'
        if (Object.prototype.hasOwnProperty.call(ref, p)) {
          ref = ref[p];
        } else if (p.includes(':')) {
          // Try without namespace prefix
            const withoutNs = p.split(':').pop();
            if (Object.prototype.hasOwnProperty.call(ref, withoutNs)) {
              ref = ref[withoutNs];
            } else {
              return [];
            }
        } else {
          return [];
        }
      }
      if (Array.isArray(ref)) return ref;
      return [];
    } catch { return []; }
  }

  // Deep search fallback: find first array of objects containing candidate keys
  function findArrayWithKeys(obj, candidateKeys, maxDepth=6) {
    if (maxDepth < 0 || obj == null) return null;
    if (Array.isArray(obj)) {
      if (obj.length && typeof obj[0] === 'object') {
        const hasKey = candidateKeys.some(k => k && k in obj[0]);
        if (hasKey) return obj;
      }
    }
    if (typeof obj === 'object') {
      for (const k of Object.keys(obj)) {
        const found = findArrayWithKeys(obj[k], candidateKeys, maxDepth-1);
        if (found) return found;
      }
    }
    return null;
  }

  async function renderGraphWithMapping(graphType, ds) {
    if (!ds) { statusMsg('Select a data source first.', 'warning'); return; }
    if (!activeGenericMapping) { statusMsg('Select and apply a mapping first.', 'warning'); return; }
    const rowPath = activeGenericMapping.rowPath;
    const mappings = { ...activeGenericMapping };
    // Prepare namespace fallbacks
  ['x','y','label','color','source','target','longitude','latitude'].forEach(r => {
      if (mappings[r] && mappings[r].includes(':')) {
        const noNs = mappings[r].split(':').pop();
        mappings[r + '_fallback'] = noNs;
      }
    });
    try {
      const resp = await fetch('../data/ApiResponse/' + ds);
      if (!resp.ok) throw new Error('Data load failed');
      const raw = await resp.json();
      let rows = rowPath ? extractRows(raw, rowPath) : (Array.isArray(raw) ? raw : raw); // if no rowPath assume raw
      if ((!rows || !rows.length) && rowPath && raw.response && raw.response.data) {
        const prefixed = 'response.data.' + rowPath;
        rows = extractRows(raw, prefixed);
        if (rows && rows.length) statusMsg('Applied response.data prefix to rowPath', 'warning');
      }
      if ((!rows || !rows.length) && rowPath && rowPath.includes(':')) {
        const alt = rowPath.split('.').map(seg => seg.includes(':') ? seg.split(':').pop() : seg).join('.');
        rows = extractRows(raw, alt);
        if (rows && rows.length) statusMsg('Used namespace-stripped rowPath variant', 'warning');
      }
      if ((!rows || !rows.length)) {
        const candidateKeys = Object.values(mappings).filter(v => typeof v === 'string');
        const found = findArrayWithKeys(raw, candidateKeys);
        if (found) { rows = found; statusMsg('Deep search located candidate data array', 'warning'); }
      }
      if (!rows || !rows.length) statusMsg('No rows resolved for rowPath; rendering with empty dataset', 'danger');
      await window.graphRegistry.loadAndRender(graphType, document.getElementById('graphContainer'), rows, mappings, { width: window.innerWidth, height: window.innerHeight - 80 });
    } catch (err) { statusMsg('Render failed: ' + err.message, 'danger'); }
  }

  function canRenderGraphType(graphType) {
    if (!activeGenericMapping) return false;
    const def = window.graphRegistry.getDefinition(graphType);
    if (!def) return true; // if unknown, let it attempt
    const missing = (def.requiredInputs || []).filter(inp => inp.required).map(i=>i.role).filter(role => !activeGenericMapping[role]);
    return missing.length === 0;
  }

  function listMissingRoles(graphType) {
    const def = window.graphRegistry.getDefinition(graphType);
    if (!def) return [];
    return (def.requiredInputs||[]).filter(i=>i.required && !activeGenericMapping[i.role]).map(i=>i.role);
  }

    // List of chart slugs that have a complete JS implementation and can render
    const implementedCharts = new Set([
      'tree',
      'force-directed',
      'bar-chart',
      'calendar'
    ]);

    function buildChartAccordion(){
      const panel = document.getElementById('chartCategoriesAccordion');
      if(!panel) return;
      const searchVal = document.getElementById('chartSearch').value.trim().toLowerCase();
      panel.innerHTML = '';
      const categoryNames = Object.keys(chartCategories).sort((a,b)=>a.localeCompare(b));
      let totalCharts = 0, visibleCharts = 0;
      categoryNames.forEach(cat => {
        const charts = [...chartCategories[cat]].sort((a,b)=>a.localeCompare(b));
        totalCharts += charts.length;
        const catSlug = 'cat-' + slugify(cat);
        let itemsHtml = '';
        let catVisible = false;
        let catComplete = 0;
        charts.forEach(ch => {
          const slug = slugify(ch);
          const isImplemented = implementedCharts.has(slug) || (alias[slug] && implementedCharts.has(alias[slug]));
          if(isImplemented) catComplete++;
          if(!searchVal || ch.toLowerCase().includes(searchVal)) {
            catVisible = true; visibleCharts++;
            // Add check mark if implemented
            const checkHtml = isImplemented ? '<i class="bi bi-check-circle-fill text-success me-1"></i>' : '';
            itemsHtml += `<button type="button" class="list-group-item list-group-item-action py-1 px-2 small chart-item" data-slug="${slug}">${checkHtml}${ch}</button>`;
          }
        });
        if(!catVisible) return; // skip category with no visible charts under search
        const item = document.createElement('div');
        item.className = 'accordion-item';
        item.innerHTML = `
          <h2 class="accordion-header" id="heading-${catSlug}">
            <button class="accordion-button collapsed py-1" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${catSlug}" aria-expanded="false" aria-controls="collapse-${catSlug}">
              <span class="d-flex w-100 align-items-center justify-content-between">
                <span class="small flex-grow-1 text-start" style="min-width:0;">${cat}</span>
                <span class="text-secondary small flex-shrink-0 text-end" style="width:56px;">(${catComplete}/${charts.length})</span>
              </span>
            </button>
          </h2>
          <div id="collapse-${catSlug}" class="accordion-collapse collapse" data-bs-parent="#chartCategoriesAccordion">
            <div class="accordion-body py-2 pt-1">
              <div class="list-group list-group-flush">${itemsHtml}</div>
            </div>
          </div>`;
        panel.appendChild(item);
      });
      document.getElementById('chartCount').textContent = visibleCharts !== totalCharts && searchVal ? `${visibleCharts} / ${totalCharts}` : `${totalCharts}`;
      updateChartSelectionHighlight();
    }

    function updateChartSelectionHighlight() {
      const items = document.querySelectorAll('#chartCategoriesAccordion .chart-item');
      items.forEach(i => {
        const slug = i.getAttribute('data-slug');
        const norm = alias[slug] || slug;
        i.classList.toggle('active', norm === selectedGraphType);
      });
    }

    function applyMappingFiltering() { buildChartAccordion(); }

    function statusMsg(msg, type='info') {
      const statusArea = document.getElementById('statusArea');
      const div = document.createElement('div');
      div.className = `alert alert-${type} py-1 px-2 mb-1`;
      div.style.fontSize = '12px';
      div.textContent = msg;
      statusArea.appendChild(div);
      setTimeout(()=>div.remove(), 5000);
    }

  function filterCharts(){ buildChartAccordion(); }
  document.addEventListener('DOMContentLoaded', () => { buildChartAccordion(); });
    // Supplemental logic to load DataSourceMappings.json and feed graphLoader
    let dataSourceMappings = {};
    async function loadDataSourceMappings() {
      try {
        const resp = await fetch('../data/DataSourceMappings.json?_=' + Date.now());
        if (!resp.ok) return;
        const json = await resp.json();
        dataSourceMappings = json.dataSources || {};
        populateDataSources();
      } catch {}
    }
    async function loadApiResponses() {
      try {
        const resp = await fetch('../data/ApiResponse');
        if (!resp.ok) return;
        const files = await resp.json();
        const sel = document.getElementById('dsSelect');
        sel.innerHTML = '<option value="">-- Select Data Source --</option>';
        files.filter(f=>f.endsWith('.json')).forEach(f => {
          const opt = document.createElement('option');
          opt.value = f; opt.textContent = f;
          sel.appendChild(opt);
        });
      } catch {}
    }
    function populateDataSources() {
      const dsSel = document.getElementById('dsSelect');
      const current = dsSel.value;
      if (current) populateMappings(current);
    }
    function populateMappings(ds) {
      const mapSel = document.getElementById('mappingSelect');
      mapSel.innerHTML = '';
      if (!ds || !dataSourceMappings[ds]) { mapSel.disabled = true; return; }
      const entries = Object.entries(dataSourceMappings[ds].mappings || {});
      if (entries.length === 0) { mapSel.disabled = true; return; }
      mapSel.disabled = false;
      entries.forEach(([name, def]) => {
        const opt = document.createElement('option');
        opt.value = name; opt.textContent = name;
        mapSel.appendChild(opt);
      });
      // auto-select first and apply generic mapping without rendering
      if (mapSel.options.length) {
        mapSel.selectedIndex = 0;
        applyGenericMapping();
      }
    }
    function applyGenericMapping() {
      const ds = document.getElementById('dsSelect').value;
      const mappingName = document.getElementById('mappingSelect').value;
      activeGenericMapping = null;
      selectedGraphType = null;
      updateChartSelectionHighlight();
      if (!ds || !mappingName || !dataSourceMappings[ds]) return;
      const mappingDef = dataSourceMappings[ds].mappings[mappingName];
      if (!mappingDef) return;
      activeMappingName = mappingName;
      const unified = {};
      const graphs = mappingDef.graphs || {};
      Object.values(graphs).forEach(g => {
        const mm = g.mappings || {};
  ['rowPath','x','y','label','color','source','target','value','parent','children','longitude','latitude','capital','income','region'].forEach(k => {
          if (mm[k] && unified[k] == null) unified[k] = mm[k];
        });
      });
      if (!unified.rowPath && mappingDef.rowPath) unified.rowPath = mappingDef.rowPath;
      activeGenericMapping = unified;
      allowedGraphTypes = null;
  applyMappingFiltering();
      statusMsg('Mapping ready. Choose a graph to render.', 'info');
    }
    document.addEventListener('DOMContentLoaded', () => {
      loadApiResponses();
      loadDataSourceMappings();
      document.getElementById('dsSelect').addEventListener('change', e => {
        activeGenericMapping = null;
        populateMappings(e.target.value);
      });
      document.getElementById('mappingSelect').addEventListener('change', applyGenericMapping);
      // Floating picker open/close
      const openBtn = document.getElementById('openChartPicker');
      const panel = document.getElementById('chartPickerPanel');
      const closeBtn = document.getElementById('closeChartPicker');
      openBtn.addEventListener('click', () => { panel.classList.remove('d-none'); buildChartAccordion(); });
      closeBtn.addEventListener('click', () => { panel.classList.add('d-none'); });
      document.addEventListener('click', e => {
        if(panel.classList.contains('d-none')) return;
        if(panel.contains(e.target) || e.target === openBtn) return;
        panel.classList.add('d-none');
      });
      // Delegate chart selection
      panel.addEventListener('click', e => {
        const btn = e.target.closest('.chart-item');
        if(!btn) return;
        const slug = btn.getAttribute('data-slug');
        if(!slug) return;
        const graphType = alias[slug] || slug;
        const ds = document.getElementById('dsSelect').value;
        if (!ds) { statusMsg('Select a data source first.', 'warning'); return; }
        selectedGraphType = graphType;
        updateChartSelectionHighlight();
        if (!canRenderGraphType(graphType)) {
          const missing = listMissingRoles(graphType).join(', ');
          statusMsg('Cannot render ' + graphType + ' missing roles: ' + missing, 'warning');
          return;
        }
        panel.classList.add('d-none');
        renderGraphWithMapping(graphType, ds);
      });
    });
  </script>
  <style>
    .panel-header:hover { background:#1d1f23; }
    .panel-header .btn { pointer-events:auto; }
    /* Highlight selected chart */
    #chartCategoriesAccordion .chart-item.active { font-weight:600; background:#2b3035; }
    #chartPickerPanel::-webkit-scrollbar { width: 8px; }
    #chartPickerPanel::-webkit-scrollbar-thumb { background:#333; border-radius:4px; }
    #chartPickerPanel .accordion-button { background:#212529; color:#ddd; }
    #chartPickerPanel .accordion-button:not(.collapsed) { background:#2b3035; color:#fff; }
    #chartPickerPanel .list-group-item { background:transparent; color:#ddd; border:none; border-radius:0; }
    #chartPickerPanel .list-group-item:hover { background:#343a40; }
    #chartPickerPanel .list-group-item.active { background:#495057; color:#fff; }
    /* Evenly align category names and ratios in accordion headers */
    #chartCategoriesAccordion .accordion-button .d-flex { width: 100%; }
    #chartCategoriesAccordion .accordion-button .flex-grow-1 { flex: 1 1 0%; min-width: 0; }
    #chartCategoriesAccordion .accordion-button .flex-shrink-0 { flex-shrink: 0; text-align: right; }
    #chartCategoriesAccordion .accordion-button .text-end { text-align: right !important; }
  </style>
  <!-- Mapping Table Popup -->
  <div id="mappingTablePanel" class="card shadow border-secondary d-none" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:min(700px,90%); height:82vh; overflow:hidden; z-index:1999; background:#1a1d21;">
    <div class="card-header py-2 d-flex justify-content-between align-items-center">
      <strong class="small">Mappings</strong>
      <div class="d-flex gap-2">
        <button id="transposeMappingTable" type="button" class="btn btn-sm btn-outline-warning" title="Transpose Table"><i class="bi bi-arrow-left-right"></i></button>
        <button id="exportMappingCsv" type="button" class="btn btn-sm btn-outline-light" title="Export CSV"><i class="bi bi-download"></i></button>
        <button id="closeMappingTable" type="button" class="btn btn-sm btn-outline-light"><i class="bi bi-x"></i></button>
      </div>
    </div>
    <div class="card-body p-0" style="height:100%; display:flex; flex-direction:column;">
      <div class="p-2"><input id="mappingGlobalSearch" type="text" class="form-control form-control-sm" placeholder="Search mappings"></div>
      <div id="mappingTable" style="flex:1; overflow:auto;"></div>
      <div class="p-2 small text-secondary" id="mappingTableStatus"></div>
    </div>
  </div>
  <!-- Data Table Popup -->
  <div id="dataTablePanel" class="card shadow border-secondary d-none" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:min(900px,95%); height:82vh; overflow:hidden; z-index:1999; background:#1a1d21;">
    <div class="card-header py-2 d-flex justify-content-between align-items-center">
      <strong class="small">Data Fields</strong>
      <div class="d-flex gap-2">
        <button id="closeDataTable" type="button" class="btn btn-sm btn-outline-light"><i class="bi bi-x"></i></button>
      </div>
    </div>
    <div class="card-body p-0" style="height:100%; display:flex; flex-direction:column;">
      <div class="p-2 d-flex gap-2 align-items-center">
        <input id="mappingDataSearch" type="text" class="form-control form-control-sm" placeholder="Search data">
        <span class="small text-secondary" id="mappingDataStatus"></span>
      </div>
      <div id="mappingDataTable" style="flex:1; overflow:auto;"></div>
    </div>
  </div>
  <script>
  let mappingTableInstance=null; let mappingDataTableInstance=null;
    function buildMappingRows(){
      const rows=[]; if(!dataSourceMappings) return rows; const ds=document.getElementById('dsSelect').value; if(!ds||!dataSourceMappings[ds]) return rows; const maps=dataSourceMappings[ds].mappings||{}; Object.entries(maps).forEach(([mName,mDef])=>{const graphs=mDef.graphs||{}; Object.entries(graphs).forEach(([gName,gObj])=>{const mm=gObj.mappings||{}; Object.keys(mm).sort((a,b)=>a.localeCompare(b)).forEach(k=>{rows.push({mapping:mName,graph:gName,role:k,value:mm[k]});});});}); return rows; }
  // --- Mapping Table State ---
  let mappingTableTransposed = false;
  let mappingTableColumnOrder = null;
  function initOrRefreshMappingTable(){
    const panel=document.getElementById('mappingTablePanel');
    if(panel.classList.contains('d-none')) return;
    let data=buildMappingRows();
    const status=document.getElementById('mappingTableStatus');
    status.textContent=data.length+' rows';
    const tableEl=document.getElementById('mappingTable');
    let cols=[
      {title:"Mapping",field:"mapping",headerFilter:true, sorter:"string"},
      {title:"Graph",field:"graph",headerFilter:true, sorter:"string"},
      {title:"Role",field:"role",headerFilter:true, sorter:"string"},
      {title:"Value",field:"value",headerFilter:true, sorter:"string"}
    ];
    // Apply saved column order if present
    if (mappingTableColumnOrder && Array.isArray(mappingTableColumnOrder)) {
      cols = mappingTableColumnOrder.map(f => cols.find(c => c.field === f)).filter(Boolean);
    }
    // Transpose logic: swap rows/columns (simple demo: swap role/value as columns/rows)
    if (mappingTableTransposed) {
      // For demo: show roles as columns, mappings as rows
      // Build unique roles and mappings
      const roles = Array.from(new Set(data.map(r=>r.role)));
      const mappings = Array.from(new Set(data.map(r=>r.mapping)));
      // Build transposed data
      const tData = mappings.map(m => {
        const row = { mapping: m };
        roles.forEach(r => {
          const found = data.find(d => d.mapping === m && d.role === r);
          row[r] = found ? found.value : '';
        });
        return row;
      });
      cols = [{title:'Mapping', field:'mapping', headerFilter:true, sorter:'string'}].concat(
        roles.map(r => ({ title: r, field: r, headerFilter:true, sorter:'string', movable:true }))
      );
      data = tData;
    }
    if(!mappingTableInstance){
      mappingTableInstance=new Tabulator(tableEl,{
        data:data,
        layout:"fitDataFill",
        pagination:"local",
        paginationSize:1000,
        paginationSizeSelector:[10,25,50,100],
        columns:cols,
        placeholder:"No mappings",
        movableColumns:true,
        rowFormatter:function(row){
          const p=row.getPrevRow(); if(!p) return; const d=row.getData(); const pd=p.getData();
          if(d.mapping===pd.mapping){ row.getCell('mapping').getElement().innerHTML=''; }
          if(d.graph===pd.graph && d.mapping===pd.mapping && row.getCell('graph')){ row.getCell('graph').getElement().innerHTML=''; }
        },
        columnMoved:function(column, columns){
          // Save new column order
          mappingTableColumnOrder = columns.map(c => c.getField());
          // TODO: persist this order with mapping config
        }
      });
      const searchInput=document.getElementById('mappingGlobalSearch');
      searchInput.addEventListener('input',()=>{
        const v=searchInput.value.toLowerCase();
        mappingTableInstance.setFilter(function(r){ const d=r.getData(); return !v || Object.values(d).some(val=> String(val).toLowerCase().includes(v)); });
        adjustMappingTablePagination();
      });
    } else {
      mappingTableInstance.setColumns(cols);
      mappingTableInstance.replaceData(data);
    }
    setTimeout(adjustMappingTablePagination,30);
  }
  function buildMappingDataRows(){ const rows=[]; const ds=document.getElementById('dsSelect').value; if(!ds||!activeGenericMapping) return rows; return rows; }
  async function refreshMappingDataTable(){ const panel=document.getElementById('dataTablePanel'); if(panel.classList.contains('d-none')) return; const ds=document.getElementById('dsSelect').value; if(!ds||!activeGenericMapping){ if(mappingDataTableInstance) mappingDataTableInstance.clearData(); return; } try { const resp=await fetch('../data/ApiResponse/'+ds+'?_='+Date.now()); if(!resp.ok) return; const raw=await resp.json(); const rowPath=activeGenericMapping.rowPath; let rows=rowPath?extractRows(raw,rowPath): (Array.isArray(raw)?raw:[]); if(!Array.isArray(rows)) rows=[]; const roles=Object.keys(activeGenericMapping).filter(k=>!k.endsWith('_fallback')&&k!=='rowPath'); function getVal(obj,path){ if(!path) return ''; const segs=path.split('.'); let ref=obj; for(const s of segs){ if(ref==null) return ''; if(Object.prototype.hasOwnProperty.call(ref,s)) ref=ref[s]; else if(s.includes(':')){ const alt=s.split(':').pop(); if(Object.prototype.hasOwnProperty.call(ref,alt)) ref=ref[alt]; else return ''; } else return ''; } return typeof ref==='object'? JSON.stringify(ref): ref; } const data=rows.slice(0,500).map(r=>{ const o={}; roles.forEach(role=>{ o[role]=getVal(r,activeGenericMapping[role]); }); return o; }); const status=document.getElementById('mappingDataStatus'); status.textContent=data.length+' rows'; const tableEl=document.getElementById('mappingDataTable'); if(!mappingDataTableInstance){ const cols=roles.map(r=>({title:r, field:r, sorter:'string', headerFilter:true})); mappingDataTableInstance=new Tabulator(tableEl,{ data:data, layout:'fitDataFill', pagination:'local', paginationSize:1000, columns:cols, placeholder:'No data' }); const search=document.getElementById('mappingDataSearch'); search.addEventListener('input',()=>{ const v=search.value.toLowerCase(); mappingDataTableInstance.setFilter(function(row){ const d=row.getData(); return !v || Object.values(d).some(val=> String(val).toLowerCase().includes(v)); }); }); } else { const existingCols=mappingDataTableInstance.getColumns().map(c=>c.getField()); const newRoles=roles.filter(r=>!existingCols.includes(r)); if(newRoles.length){ mappingDataTableInstance.setColumns(roles.map(r=>({title:r, field:r, sorter:'string', headerFilter:true}))); } mappingDataTableInstance.replaceData(data); } } catch(e){} }
async function refreshMappingDataTable(){
  const panel=document.getElementById('dataTablePanel');
  if(panel.classList.contains('d-none')) return;
  const ds=document.getElementById('dsSelect').value;
  if(!ds||!activeGenericMapping){ if(mappingDataTableInstance) mappingDataTableInstance.clearData(); return; }
  try {
    const resp=await fetch('../data/ApiResponse/'+ds+'?_='+Date.now());
    if(!resp.ok) return;
    const raw=await resp.json();
    const rowPath=activeGenericMapping.rowPath;
    let rows=rowPath?extractRows(raw,rowPath):(Array.isArray(raw)?raw:[]);
    // Fallback: try response.data.rowPath if no rows
    if((!rows||!rows.length) && rowPath && raw.response && raw.response.data){
      const prefixed = 'response.data.' + rowPath;
      rows = extractRows(raw, prefixed);
    }
    if(!Array.isArray(rows)) rows=[];
    const roles=Object.keys(activeGenericMapping).filter(k=>!k.endsWith('_fallback')&&k!=='rowPath');
    function getVal(obj,path){
      if(!path) return '';
      const segs=path.split('.');
      let ref=obj;
      for(const s of segs){
        if(ref==null) return '';
        if(Object.prototype.hasOwnProperty.call(ref,s)) ref=ref[s];
        else if(s.includes(':')){
          const alt=s.split(':').pop();
          if(Object.prototype.hasOwnProperty.call(ref,alt)) ref=ref[alt];
          else return '';
        } else return '';
      }
      return typeof ref==='object'? JSON.stringify(ref): ref;
    }
    const data=rows.slice(0,500).map(r=>{
      const o={};
      roles.forEach(role=>{ o[role]=getVal(r,activeGenericMapping[role]); });
      return o;
    });
    const status=document.getElementById('mappingDataStatus');
    status.textContent=data.length+' rows';
    const tableEl=document.getElementById('mappingDataTable');
    if(!mappingDataTableInstance){
      const cols=roles.map(r=>({title:r, field:r, sorter:'string', headerFilter:true}));
      mappingDataTableInstance=new Tabulator(tableEl,{ data:data, layout:'fitDataFill', pagination:'local', paginationSize:1000, columns:cols, placeholder:'No data' });
      const search=document.getElementById('mappingDataSearch');
      search.addEventListener('input',()=>{
        const v=search.value.toLowerCase();
        mappingDataTableInstance.setFilter(function(row){
          const d=row.getData();
          return !v || Object.values(d).some(val=> String(val).toLowerCase().includes(v));
        });
      });
    } else {
      const existingCols=mappingDataTableInstance.getColumns().map(c=>c.getField());
      const newRoles=roles.filter(r=>!existingCols.includes(r));
      if(newRoles.length){ mappingDataTableInstance.setColumns(roles.map(r=>({title:r, field:r, sorter:'string', headerFilter:true}))); }
      mappingDataTableInstance.replaceData(data);
    }
  } catch(e){}
}
  function adjustMappingTablePagination(){ if(!mappingTableInstance) return; const panel=document.getElementById('mappingTablePanel'); const status=document.getElementById('mappingTableStatus'); const footer=panel.querySelector('#mappingTable .tabulator-footer'); const topBlock=document.getElementById('mappingGlobalSearch').parentElement; const availLeft=panel.clientHeight - topBlock.offsetHeight - status.offsetHeight - 32; mappingTableInstance.setHeight(availLeft+'px'); const total=mappingTableInstance.getDataCount(); const approx=30; if(total*approx>availLeft){ const ps=total>25?25:total; mappingTableInstance.setPageSize(ps||1); if(footer) footer.style.display='block'; } else { mappingTableInstance.setPageSize(total||1); if(footer) footer.style.display='none'; } if(mappingDataTableInstance){ const search2=document.getElementById('mappingDataSearch').parentElement; const availRight=panel.clientHeight - search2.offsetHeight - 32; mappingDataTableInstance.setHeight(availRight+'px'); const footer2=panel.querySelector('#mappingDataTable .tabulator-footer'); const total2=mappingDataTableInstance.getDataCount(); if(total2*approx>availRight){ const ps2=total2>25?25:total2; mappingDataTableInstance.setPageSize(ps2||1); if(footer2) footer2.style.display='block'; } else { mappingDataTableInstance.setPageSize(total2||1); if(footer2) footer2.style.display='none'; } }
  }
  document.addEventListener('DOMContentLoaded',()=>{
    // Mapping Table
    const mappingBtn=document.getElementById('toggleMappingTable');
    const mappingIcon=document.getElementById('mappingTableIcon');
    const mappingPanel=document.getElementById('mappingTablePanel');
    const mappingCloseBtn=document.getElementById('closeMappingTable');
    const exportBtn=document.getElementById('exportMappingCsv');
    const transposeBtn=document.getElementById('transposeMappingTable');
    mappingBtn.addEventListener('click',()=>{ const hidden=mappingPanel.classList.toggle('d-none'); mappingIcon.className= hidden ? 'bi bi-table' : 'bi bi-table'; if(!hidden){ initOrRefreshMappingTable(); } });
    mappingCloseBtn.addEventListener('click',()=>{ mappingPanel.classList.add('d-none'); mappingIcon.className='bi bi-table'; });
    exportBtn.addEventListener('click',()=>{ if(!mappingTableInstance){return;} const rows=mappingTableInstance.getData(); const csvData=rows.map(r=>[r.mapping,r.graph,r.role,r.value].map(s=> '"'+String(s).replace(/"/g,'""')+'"').join(',')).join('\n'); fetch('/SaveTableExport',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ name:'Mappings_'+(document.getElementById('dsSelect').value||'data'), csv:'mapping,graph,role,value\n'+csvData }) }).then(r=>r.json()).then(j=>{ const s=document.getElementById('mappingTableStatus'); if(j.success){ s.textContent='Saved '+j.file; } else { s.textContent='Export failed'; } }); });
    // Transpose button
    transposeBtn.addEventListener('click',()=>{
      mappingTableTransposed = !mappingTableTransposed;
      initOrRefreshMappingTable();
      // TODO: persist transposed state with mapping config
    });
    // Data Table
    const dataBtn=document.getElementById('toggleDataTable');
    const dataIcon=document.getElementById('dataTableIcon');
    const dataPanel=document.getElementById('dataTablePanel');
    const dataCloseBtn=document.getElementById('closeDataTable');
    dataBtn.addEventListener('click',()=>{ const hidden=dataPanel.classList.toggle('d-none'); dataIcon.className= hidden ? 'bi bi-table' : 'bi bi-table'; if(!hidden){ refreshMappingDataTable(); } });
    dataCloseBtn.addEventListener('click',()=>{ dataPanel.classList.add('d-none'); dataIcon.className='bi bi-table'; });
    // Escape closes both
    document.addEventListener('keydown',e=>{ if(e.key==='Escape'){ if(!mappingPanel.classList.contains('d-none')){ mappingPanel.classList.add('d-none'); mappingIcon.className='bi bi-table'; } if(!dataPanel.classList.contains('d-none')){ dataPanel.classList.add('d-none'); dataIcon.className='bi bi-table'; } } });
    window.addEventListener('resize',adjustMappingTablePagination);
  });
  document.addEventListener('change',e=>{ if(e.target && (e.target.id==='dsSelect'||e.target.id==='mappingSelect')){ if(mappingTableInstance){ initOrRefreshMappingTable(); } if(mappingDataTableInstance){ refreshMappingDataTable(); } }});
  </script>
</body>
</html>
